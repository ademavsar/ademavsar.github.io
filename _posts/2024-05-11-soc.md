---
title: SOC L1
categories: []
tags: []
pin: false
---

## Endpoint Security Monitoring

{% drawer Task 2 Endpoint Güvenliği Temelleri %}

Temel Windows İşlemleri

Endpoint günlüklerine derinlemesine dalış yapmadan önce, Windows İşletim Sistemi'nin nasıl çalıştığını temel olarak öğrenmemiz gerekiyor. Önceden bir bilgiye sahip olmaksızın, olaylar yığını içinde bir anormalliği ayırt etmek sorunlu olabilir.

Temel Windows İşlemleri hakkında daha fazla bilgi edinmek için, Windows'a özgü Görev Yöneticisi adlı araç, Windows makinesi içindeki altta yatan işlemleri anlamamıza yardımcı olabilir.

Görev Yöneticisi, kullanıcılara Windows sisteminde neyin çalıştığını gösteren, grafik kullanıcı arayüzüne sahip yerleşik bir Windows yardımcı programıdır. Ayrıca, her işlemin CPU ve bellek kullanımını ne kadar etkilediği hakkında bilgi sağlar. Bir program yanıt vermediğinde, Görev Yöneticisi işlemi sonlandırmak için kullanılır.

![Görev Yöneticisi](https://assets.tryhackme.com/additional/windows-processes/taskmanager-7.png)

Görev Yöneticisi, arka planda çalışan Temel Windows İşlemlerinden bazılarını sağlar. Aşağıda, normal davranış olarak kabul edilen işlemlerin bir özeti yer almaktadır.

Not: **">"** simgesi, ebeveyn-çocuk ilişkisini temsil eder. `Sistem (Ebeveyn) > smss.exe (Çocuk)`

- System
- System > smss.exe
- csrss.exe
- wininit.exe
- wininit.exe > services.exe
- wininit.exe > services.exe > svchost.exe
- lsass.exe
- winlogon.exe
- explorer.exe

Ayrıca, ebeveyn-çocuk ilişkisi gösterilmeyen işlemlerin normal şartlar altında Ebeveyn İşlemi olmaması gerekir, Sistem işlemi hariç, bu işlemin yalnızca **Sistem Boşta İşlemi (0)** olarak bir ebeveyn işlemi olmalıdır.

Bu konu hakkında daha fazla bilgi edinmek için [Temel Windows İşlemleri Odası](https://tryhackme.com/room/btwindowsinternals)’na başvurabilirsiniz.

Sysinternals

Temel Windows İşlemleri hakkındaki bilgilerimizle, şimdi Windows makinesinin arka planında çalışan sanat eserlerini analiz etmek için kullanılan araç setini tartışmaya geçebiliriz.

Sysinternals araçları, 70'den fazla Windows tabanlı araçtan oluşan bir derlemedir. Araçların her biri aşağıdaki kategorilerden birine girer:

- Dosya ve Disk Yardımcı Programları
- Ağ Yardımcı Programları
- İşlem Yardımcı Programları
- Güvenlik Yardımcı Programları
- Sistem Bilgisi
- Çeşitli

Bu görev için uç nokta incelemesinde en çok kullanılan iki Sysinternals aracını tanıtacağız.

- **TCPView** - Ağ Yardımcı Programı aracı.
- **Process Explorer** - İşlem Yardımcı Programı aracı.

TCPView

"TCPView, sisteminizdeki tüm TCP ve UDP uç noktalarının detaylı listelerini gösterecek bir Windows programıdır, yerel ve uzak adresleri ile TCP bağlantılarının durumunu içerir. Windows Server 2008, Vista ve XP'de TCPView, uç noktayı sahiplenen sürecin adını da raporlar. TCPView, Windows ile birlikte gelen Netstat programının daha bilgilendirici ve elverişli sunulan bir alt kümesini sağlar. TCPView indirmesi, aynı işlevselliğe sahip komut satırı versiyonu olan Tcpvcon'u da içerir." (resmi tanım)

![TCPView](https://assets.tryhackme.com/additional/sysinternals/tcpview0.png)

Yukarıda gösterildiği gibi, bir süreç tarafından başlatılan her bağlantı, araç tarafından listelenir, bu da eş zamanlı olarak gerçekleştirilen ağ olaylarını ilişkilendirmede yardımcı olabilir.

Process Explorer

Process Explorer görüntüsü iki alt pencereden oluşur. Üst pencere her zaman şu anda aktif olan işlemlerin bir listesini ve bunların sahip oldukları hesapların adlarını gösterirken, alt pencerede gösterilen bilgi, Process Explorer'ın hangi modda olduğuna bağlıdır: eğer işlem modunda ise, üst pencerede seçilen işlemin açtığı kolları göreceksiniz; Process Explorer DLL modunda ise, işlemin yüklediği DLL'ler ve bellek haritalı dosyaları göreceksiniz.

![Process Explorer](https://assets.tryhackme.com/additional/sysinternals/procexp-svchost-services.png)

Process Explorer, çalışan bir işlemin ayrıntılarını inceleme imkanı sağlar. Bunlar şunları içerir:

- İlişkilendirilmiş hizmetler
- Çağrılan ağ trafiği
- Dosya veya dizinler gibi kollar
- Yüklenen DLL'ler ve bellek haritalı dosyalar

Sysinternals hakkında daha fazla bilgi edinmek için [Sysinternals Odası](https://tryhackme.com/room/btsysinternalssg)'na başvurabilirsiniz.
{% enddrawer %}

{% drawer Task 3 Endpoint Logging and Monitoring %}

Önceki görevden, Windows İşletim sistemi hakkında temel işlemler ve makinede çalışan olayları ve eserleri analiz etmek için gerekli araçlar hakkında temel bilgiler öğrendik. Ancak bu, gerçek zamanlı olayları gözlemlememizi sınırlar. Bununla birlikte, endpoint kayıtlarının önemini tanıtacağız, bu da farklı endpoint'lerde önemli olayları denetlememize, toplamamıza ve arama yetenekleri için birleştirmemize ve anormallikleri otomatik olarak tespit etmeye yönelik daha iyi yöntemler geliştirmemize olanak tanır.

Windows Olay Günlükleri

Windows Event Logs, bir metin editörü kullanılarak görüntülenebilen metin dosyaları değildir. Ancak, ham veriler Windows API kullanılarak XML'ye çevrilebilir. Bu günlük dosyalarındaki olaylar, .evt veya .evtx uzantılı özel bir ikili formatında saklanır. .evtx dosya uzantısına sahip günlük dosyaları genellikle `C:\Windows\System32\winevt\Logs` konumunda bulunur.

Windows sistem içinde bu olay günlüklerine erişmenin üç ana yolu vardır:

1. Olay Görüntüleyici (GUI-tabanlı uygulama)
2. Wevtutil.exe (komut satırı aracı)
3. Get-WinEvent (PowerShell cmdlet)

Aşağıda, **Event Viewer** aracı kullanılarak görüntülenen günlüklerin bir örneği gösterilmiştir.

![Windows Event Viewer](https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/d8e5eb05be195a17c96ff607fa75ef72.png)

Windows Event Logs hakkında daha fazla bilgi edinmek için [Windows Event Logs Room](https://tryhackme.com/room/windowseventlogs)’a başvurabilirsiniz.

Sysmon

Sysmon, Windows'ta olayları izlemek ve kaydetmek için kullanılan bir araçtır ve genellikle kurumsal düzeyde izleme ve kayıt çözümlerinin bir parçası olarak kullanılır. Windows Sysinternals paketinin bir parçası olarak Sysmon, Windows Event Logs'a benzer ancak daha detaylı ve granüler kontrol sunar.

Sysmon, ortamınızdaki anomallikleri belirlemeye yardımcı olan detaylı ve yüksek kaliteli günlükler ile olay izlemeyi toplar. Genellikle, olayları toplayan, filtreleyen ve görselleştiren bir güvenlik bilgi ve olay yönetimi (SIEM) sistemi veya diğer günlük çözümleme çözümleri ile kullanılır.

Son olarak, Sysmon 27 türde Event ID içerir, bunların her biri gereken yapılandırma dosyasında olayların nasıl ele alınacağını ve analiz edileceğini belirtmek için kullanılabilir. SwiftOnSecurity tarafından oluşturulan farklı Event ID'leri denetleyen bir yapılandırma dosyası örneği [burada](https://github.com/SwiftOnSecurity/sysmon-config) bağlantısında bulunabilir.

Aşağıdaki resim, **Event Viewer** kullanılarak görüntülenen bir Sysmon günlüklerinin örnek bir setini göstermektedir.

![Sysmon Logs](https://i.imgur.com/HtS0AOx.png)

Sysmon hakkında daha fazla bilgi edinmek için [Sysmon Room](https://tryhackme.com/room/sysmon)’a başvurabilirsiniz.

Osquery

Osquery, Facebook tarafından oluşturulan açık kaynaklı bir araçtır. Osquery ile Güvenlik Analistleri, Olay Yanıtlayıcılar ve Tehdit Avcıları, bir uç noktayı (veya birden çok uç noktayı) SQL sözdizimi kullanarak sorgulayabilir. Osquery; Windows, Linux, macOS ve FreeBSD platformlarında kurulabilir.

Osquery interaktif konsolu/ kabuğu ile etkileşime geçmek için CMD (veya PowerShell) açın ve çalıştırın. Interaktif kabuğa başarıyla girdiğinizi yeni komut isteminden anlayacaksınız. `osqueryi`

cmd.exe

           `C:\Users\Administrator\> osqueryi
Using a virtual database. Need help, type 'help'
osquery>` 

Osquery kullanarak gerçekleştirilebilecek bir örnek kullanım durumu, sürecin adına göre önemli süreç bilgilerini listelemektir.

osqueryi

           `osquery> select pid,name,path from processes where name='lsass.exe';
+-----+-----------+-------------------------------+
| pid | name      | path                          |
+-----+-----------+-------------------------------+
| 748 | lsass.exe | C:\Windows\System32\lsass.exe |
+-----+-----------+-------------------------------+
osquery>` 

Osquery yalnızca makine içindeki olayları sorgulamanıza izin verir. Ancak Kolide Fleet ile, yerel olarak bir uç noktayı sorgulamak yerine Kolide Fleet UI aracılığıyla birden çok uç noktayı sorgulayabilirsiniz. Aşağıda Kolide Fleet'in bir örneği, `lsass` işlemi çalışan makineleri listeleme sonucunu göstermektedir.

![Kolide](https://assets.tryhackme.com/additional/osquery/kolide_query_filter2.png)

OSQuery hakkında daha fazla bilgi edinmek için [OSQuery Room](https://tryhackme.com/room/osqueryf8)’a başvurabilirsiniz.

Wazuh

Wazuh, her ölçekteki ortamlarda Güvenlik Mühendisleri tarafından dağıtılabilen açık kaynaklı, ücretsiz ve kapsamlı bir EDR çözümüdür.

Wazuh, ajanları izlemek istediğiniz cihazlara kurulan ajanlar için sorumlu olan özel bir yönetici cihazı kullanan bir yönetim ve ajan modeli üzerinde çalışır.

Belirtildiği gibi, Wazuh bir EDR'dir; EDR'nin ne olduğunu kısaca açıklayalım. Uç nokta tespiti ve yanıtı (EDR), bir tehdit veya güvenlik ihlali işaret edebilecek bir aktiviteyi izleyen araçlar ve uygulamalardır. Bu araçların ve uygulamaların özellikleri şunları içerir:

- Cihazdaki yaygın güvenlik açıklarını denetleme
- Yetkisiz girişler, kaba kuvvet saldırıları veya ayrıcalık yükseltmeleri gibi şüpheli aktiviteler için bir cihazı proaktif olarak izleme
- Karmaşık veri ve olayları düzenli ve modern grafiklere dönüştürme
- Anormallikleri tespit etmeye yardımcı olmak için bir cihazın normal işletim davranışını kaydetme

Aşağıda, Wazuh'un nasıl çalıştığını gösteren bir örnek görünüm yer almaktadır.

![Wazuh in action](https://tryhackme-images.s3.amazonaws.com/user-uploads/5de96d9ca744773ea7ef8c00/room-content/6c2d68f59482de413940f2d11913fae1.gif)

Wazuh'u deneyimlemek için [Wazuh Room](https://tryhackme.com/room/wazuhct)’a başvurabilirsiniz.



Windows Olay günlükleri (.evtx dosyaları) genellikle nerede bulunur?

Gönder

OSQuery CLI'ya girmek için kullanılan komut nedir?

Gönder

EDR ne anlama gelir? Cevabı küçük harflerle verin

.
{% enddrawer %}

{% drawer Task 4 Endpoint Günlük Analizi %}

Olay Korelasyonu

Olay korelasyonu, uygulama günlükleri, endpoint günlükleri ve ağ günlükleri gibi birden fazla günlük kaynağından önemli ilişkileri tanımlar.

Olay korelasyonu, farklı günlük kaynaklarından bir arada bulunan önemli eserleri tanımlamak ve her ilgili eseri bağlamakla ilgilenir. Örneğin, bir ağ bağlantı günlüğü, Sysmon günlükleri (Olay Kimliği 3: Ağ Bağlantısı) ve Güvenlik Duvarı Günlükleri gibi çeşitli günlük kaynaklarında bulunabilir. Güvenlik Duvarı günlüğü, kaynak ve hedef IP, kaynak ve hedef port, protokol ve alınan eylemi sağlayabilir. Buna karşın, Sysmon günlükleri ağ bağlantısını başlatan işlemi ve işlemi çalıştıran kullanıcıyı verebilir.

Bu bilgilerle, iki veri kaynağından her bir eserin noktalarını birleştirebiliriz:

- Kaynak ve Hedef IP
- Kaynak ve Hedef Port
- Alınan Eylem
- Protokol
- İşlem adı
- Kullanıcı Hesabı
- Makine Adı

Olay korelasyonu, bir soruşturmada tam senaryoyu tamamlamak için puzzle parçalarını bir araya getirebilir.

Taban Çizgisi Belirleme

Taban çizgisi belirleme, neyin normal olarak beklenmesi gerektiğini bilmek sürecidir. Endpoint güvenlik izlemesi açısından, kullanıcı aktivitelerinin, altyapı boyunca ağ trafiğinin ve organizasyona ait tüm makinelerde çalışan işlemlerin standart davranışını belirlemek için geniş çapta veri toplama gerektirir. Taban çizgiyi bir referans olarak kullanarak, organizasyona tehdit oluşturabilecek sapmaları hızla belirleyebiliriz.

Aşağıda, ağınızda ne beklemeniz gerektiğini bilmek öneminin gösterildiği taban çizgisi ve olağandışı aktivitelerin örnek bir listesi yer alıyor.

<table class="table table-bordered"><tbody><tr><td><b>Taban Çizgisi</b></td><td><b>Olağandışı Aktivite</b></td></tr><tr><td>Organizasyonun çalışanları Londra'da ve normal çalışma saatleri 09:00 ile 18:00 arasındadır.</td><td>Singapur'dan saat 03:00'te VPN üzerinden kimlik doğrulama yapan bir kullanıcı var.</td></tr><tr><td>Her çalışana tek bir çalışma istasyonu atanmıştır.</td><td>Bir kullanıcı birden fazla çalışma istasyonunda kimlik doğrulaması yapmaya çalışmış.</td></tr><tr><td>Çalışanlar, yalnızca OneDrive, SharePoint ve diğer O365 uygulamaları gibi seçilmiş web sitelerine kendi çalışma istasyonlarından erişebilirler.</td><td>Bir kullanıcı Google Drive üzerine 3GB boyutunda bir dosya yüklemiş.</td></tr><tr><td>Çalışma istasyonlarına yalnızca Microsoft Uygulamaları gibi seçilmiş uygulamalar yüklenmiştir, özellikle Microsoft Word, Excel, Teams, OneDrive ve Google Chrome.</td><td>Birkaç çalışanın çalışma istasyonunda firefox.exe adında bir işlem çalıştığı gözlemlenmiştir.</td></tr></tbody></table>

İyi bir düzenli aktivite genel bakışı olmadan, herhangi bir olay bir iğne yumağı olabilir.

Soruşturma Aktivitesi

Önceki görevlerden endpoint güvenlik izlemesinin temellerini ele aldık. Şimdi, Mavi Takım Şapkasını takıp, bir meslektaşınıza ait bir çalışma istasyonunda tespit edilen şüpheli bir aktiviteyi araştırarak tartıştığımız kavramları uygulayacağız.

Bu görevde, sağlanan talimatları takip ederek tehdidi araştırmak için bu görevdeki yeşil "Siteyi Görüntüle" butonuna tıklayın ve Statik Site Laboratuvarını açın.

Simüle edilen soruşturma aktivitesi için bayrağı sağlayın.
{% enddrawer %}

{% drawer Task 5 Sonuç %}

Tebrikler! Soruşturma görevini tamamladınız.

Simüle edilen tehdit soruşturma aktivitesinde şunları öğrendik:

- Bir taban çizgisi dokümanına sahip olmak, zararlı olayları zararsız olaylardan ayırt etmenize yardımcı olur.
- Olay korelasyonu, kötü amaçlı aktivite tarafından tetiklenen eş zamanlı olayların daha derinlemesine anlaşılmasını sağlar.
- Soruşturmada her önemli eserin not alınması hayati önem taşır.
- Toplanan kötü niyetli eserler kullanılarak diğer potansiyel olarak etkilenmiş varlıkların incelenmesi ve düzeltilmesi gereklidir.

Sonuç olarak, Endpoint Güvenlik İzleme'nin temel kavramlarını ele aldık:

- **Endpoint Güvenliği Temelleri** Temel Windows İşlemleri ve Sysinternals ile ilgilendi.
- **Endpoint Günlüğü ve İzleme** Windows Olay Günlüğü ve Sysmon gibi günlükleme işlevlerini ve OSQuery ve Wazuh gibi izleme/soruşturma araçlarını tanıttı.
- **Endpoint Günlük Analizi** taban çizgisi belirleme ve olay korelasyonu gibi bir metodolojinin önemini vurguladı.

Şimdi, Endpoint Güvenlik İzleme Modülüne derinlemesine dalış yapmaya hazırsınız. Bu yolu devam etmek için, önceki görevlerde bahsedilen odalar listesine başvurabilirsiniz:

- [Temel Windows İşlemleri](https://tryhackme.com/room/btwindowsinternals)
- [Sysinternals](https://tryhackme.com/room/btsysinternalssg)
- [Windows Olay Günlükleri](https://tryhackme.com/room/windowseventlogs)
- [Sysmon](https://tryhackme.com/room/sysmon)
- [OSQuery](https://tryhackme.com/room/osqueryf8)
- [Wazuh](https://tryhackme.com/room/wazuhct)
{% enddrawer %}

## Core Windows Processes


{% drawer Task 1 Introduction %}

Bu odada, bir Windows sistemine ait çekirdek süreçleri keşfedeceğiz. Bu odanın amacı, bir Windows işletim sisteminde normal davranışları anlamanıza ve tanımanıza yardımcı olmaktır. Bu temel bilgi, bir uç noktada çalışan zararlı süreçleri tanımlamanıza yardımcı olacak.

Windows işletim sistemi, dünya genelinde en çok kullanılan işletim sistemidir (ister insanlar beğensin ister beğenmesin), ve kullanıcılarının çoğunluğu sistemin iç işleyişini tam olarak anlamaz. Kullanıcılar genellikle, karmaşık bir cihaz olan araba gibi, işlevini yerine getirdiği sürece memnundur. Arabayı çalıştırırsınız ve A noktasından B noktasına gidersiniz. Bilgisayarlar söz konusu olduğunda, web’de gezinebilmek, e-postaları okuyup yanıtlamak, alışveriş yapmak, müzik dinlemek ve film izlemek mümkün olduğunda her şey yolundadır. Kullanıcıların antivirüs programlarının gerekliliğini tam anlamıyla kavramaları uzun zaman aldı. Temel günlük bilgisayar işlevlerinden biri kesintiye uğradığında, antivirüsün önemi ortaya çıktı. Yaklaşık 5-7 yıl önce antivirüs yeterliydi (kabaca bir tahmin).

Zaman her şeyi değiştirir. Zararlı yazılımlar ve saldırılar evrildi ve antivirüs artık yeterli değil. Antivirüs, kötü amaçlı yazılımları yakalamak üzere tasarlandığı şekilde kalmış ve bu nedenle yeni tehditlere ayak uydurmakta zorlanmıştır.

Günümüzde antivirüs, katmanlı savunma yaklaşımının sadece bir parçasıdır. Antivirüslerin her kötü amaçlı ikiliyi ve süreci yakalayamaması nedeniyle, yeni güvenlik araçları olan EDR (Endpoint Detection and Response) gibi araçlar geliştirilmiştir.

Ama ne yazık ki bu yeni araçlar da %100 etkili değildir. Saldırganlar hala uç noktadaki savunmaları aşmayı başarabilmektedir. İşte burada devreye biz giriyoruz. Bir güvenlik analisti, SOC analisti, tespit mühendisi veya tehdit avcısı olsanız da, eğer araçlardan biri şüpheli bir ikili veya süreç konusunda bizi uyarırsa, araştırmalı ve bir eylem planı belirlemeliyiz. Savunmakla yükümlü olduğumuz sistemlerin beklenen davranışlarını bilerek, bu ikili veya sürecin zararsız mı yoksa zararlı mı olduğunu anlayabiliriz.


{% enddrawer %}

{% drawer Görev 2: Görev Yöneticisi %}

**Task Manager**, Windows sistemlerde neyin çalıştığını gösteren yerleşik, grafik kullanıcı arayüzüne sahip bir yardımcı programdır. Bu araç, her işlemin CPU ve bellek kullanımı gibi kaynak tüketim bilgilerini sunar. Yanıt vermeyen bir program olduğunda, Task Manager süreci sonlandırmak için kullanılır.

Eğer Task Manager ile henüz tanışmadıysanız, işte kısa bir özet:

Task Manager'ı açmak için görev çubuğuna sağ tıklayın. Yeni pencere açıldığında, aşağıda gösterildiği gibi `Task Manager` seçeneğini tıklayın.

![Task Manager](https://assets.tryhackme.com/additional/windows-processes/taskmanager.png)

Eğer açık bir uygulamanız yoksa, aşağıda gösterilen mesajı görebilirsiniz.

![Task Manager (2)](https://assets.tryhackme.com/additional/windows-processes/taskmanager-2.png)

Görüyorsunuz, çok fazla şey yok. Windows sistemlerinde birçok işlem çalışmaktadır. `Daha Fazla Detay` butonuna tıklayın.

![Task Manager - More Details](https://assets.tryhackme.com/additional/windows-processes/taskmanager-3.png)

Şimdi daha ilginç bir noktaya geldik. Task Manager'daki beş sekmeden birine dikkat edin. Varsayılan olarak, aktif sekme `Processes`dir.

Not: Kendi Windows makinenizde Task Manager çalıştırıyorsanız, ek sekmeler görebilirsiniz.

Yukarıda belirtildiği gibi, süreçler şu şekilde kategorilere ayrılmıştır: `Apps` ve `Background processes`. Gösterilmeyen bir diğer kategori ise `Windows processes`dir.

Sütunlar oldukça minimaldir. Sadece **Name**, **Status**, **CPU**, ve **Memory** sütunları görünür. Daha fazla sütun görmek için, herhangi bir sütun başlığına sağ tıklayıp daha fazla seçenek açabilirsiniz.

![Task Manager actions](https://assets.tryhackme.com/additional/windows-processes/taskmanager-4.png)

![Task Manager view](https://assets.tryhackme.com/additional/windows-processes/taskmanager-5.png)

Görünüm biraz daha iyi. Her sütunu kısaca gözden geçirelim (**Name** hariç):

- **Type** - Her süreç bir kategoriden birine girer: Apps, Background process, veya Windows process.
- **Publisher** - Bu sütun, program/dosyanın yayıncısının adını gösterir.
- **PID** - İşlem tanımlayıcı numarası olarak bilinir. Windows, bir program başlatıldığında her birine benzersiz bir PID atar.
- **Process name** - İşlemin dosya adıdır. Yukarıdaki örnekte, Task Manager'ın dosya adı Taskmrg.exe'dir.
- **Command line** - İşlemi başlatmak için kullanılan tam komut.
- **CPU** - İşlemin kullandığı CPU miktarı.
- **Memory** - İşlemin kullandığı fiziksel çalışma belleği miktarı.

Task Manager, sorun giderme veya uç noktada analiz yapma gibi durumlar için rahatlıkla kullanabileceğiniz bir araçtır.

`Details` sekmesine geçelim. Bu görünüm, bu odada tartışılacak bazı temel süreçleri sunar. PID sütununu sıralayarak PID'leri artan sırada görüntüleyin.

![Task Manager process details](https://assets.tryhackme.com/additional/windows-processes/taskmanager-6.png)

Bu süreçler hakkında daha fazla bilgi görmek için bazı ek sütunlar ekleyin. Eklemek için iyi sütunlar `Image path name` ve `Command line`dir.

Bu iki sütun, bir analistin verilen bir işlemle ilgili anomallikleri hızlıca tespit etmesine yardımcı olabilir. Aşağıdaki resimde, PID 384, svchost.exe adında bir Windows işlemi ile eşleştirilmiştir. Ancak, `Image path name` veya `Command line` beklenenin dışındaysa, bu işlem hakkında daha derin bir analiz yapabiliriz.

![Task Manager process details (2)](https://assets.tryhackme.com/additional/windows-processes/taskmanager-7.png)

İstediğiniz kadar çok sütun ekleyebilirsiniz, ancak şu anki görevinizle ilgili olacak sütunların eklenmesi önerilir.

Task Manager, işlem analizi yaparken önemli bazı bilgileri eksik bırakabilir, özellikle **parent process information**. Bu, anomallikleri belirlemede kritik bir sütundur. Örneğin, svchost.exe için eğer PID 384'ün ebeveyn işlemi services.exe değilse, bu durum daha fazla analiz gerektirir.

Bu noktayı daha da pekiştirmek için, services.exe nerede?

![Task Manager process details (3)](https://assets.tryhackme.com/additional/windows-processes/taskmanager-8.png)

Yukarıdaki resme göre, services.exe'nin PID'si 632. Ancak, svchost.exe işlemlerinden birinin PID'i 384. Svchost.exe nasıl olur da services.exe'den önce başlar? Başlamaz. Task Manager, Ebeveyn-Çocuk işlem görünümünü göstermez. Bu durumda **Process Hacker** ve **Process Explorer** gibi diğer araçlar devreye girer.

**Process Hacker**

![Process hacker](https://assets.tryhackme.com/additional/windows-processes/processhacker.png)

**Process Explorer**

![Process Explorer](https://assets.tryhackme.com/additional/windows-processes/process-explorer.png)

İlerleyen süreçte, Görev Yöneticisi yerine **Process Hacker** ve **Process Explorer** kullanarak her Windows işlemi hakkında daha ayrıntılı bilgi edinmeye devam edeceğiz.


Görev Yöneticisi dışında, bir Windows sisteminde çalışan işlemler hakkında bilgi edinmek için komut satırı eşdeğerlerini de öğrenmelisiniz:
- `tasklist`
- `Get-Process` veya `ps` (PowerShell)
- `wmic`

{% enddrawer %}

---
> ``scvchost.exe``, ``services.exe``'den önce başlamaz
> 
{: .prompt-danger }

{% drawer Task 3 System %}

Listedeki ilk Windows process'i **System**'dir. Daha önceki bir bölümde, herhangi bir process için PID'in rastgele atanacağı belirtilmişti, ancak System process'i için bu durum geçerli değildir. System process'inin PID'i her zaman 4'tür. Bu process tam olarak ne yapar?

Kullanıcı modu nedir? Çekirdek modu nedir? Her birini anlamak için şu [bağlantıyı](https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/user-mode-and-kernel-mode) ziyaret edin.

Peki, bu process için normal davranış nedir? Process Explorer kullanarak System'in özelliklerine bakalım.

![System properties](https://assets.tryhackme.com/additional/windows-processes/system.png)

**Image Path**: N/A

**Parent Process**: None

**Number of Instances**: One

**User Account**: Local System

**Start Time**: At boot time

System özelliklerini Process Hacker kullanarak incelediğimizde bilgiler biraz farklıdır.

![System properties (2)](https://assets.tryhackme.com/additional/windows-processes/system2.png)

**Image Path**: C:\\Windows\\system32\\ntoskrnl.exe (NT OS Kernel)

**Parent Process**: System Idle Process (0)

Bu teknik olarak doğru. Process Hacker'ın bu işlemin meşru (Doğrulanmış) Microsoft Windows olduğunu doğruladığını fark edebilirsiniz.

Bu process için alışılmadık davranışlar nelerdir?

- System Idle Process (0) dışında bir Parent Process
- System'in birden fazla örneği. (Yalnızca bir örnek olmalı)
- Farklı bir PID. (PID'nin her zaman 4 olduğunu unutmayın)
- 0 Numaralı Oturumda çalışmıyor

{% enddrawer %}

{% drawer Task 4 System > smss.exe %}

Bir sonraki process **smss.exe** (**Session Manager Subsystem**) yani **Windows Session Manager** olarak da bilinir. Bu process, yeni oturumlar oluşturulmasından sorumludur ve kernel tarafından başlatılan ilk user-mode process'tir.

Bu process, Windows alt sistemlerinin kernel ve user modlarını başlatır (NT Mimarisi hakkında daha fazla bilgiyi [buradan](https://en.wikipedia.org/wiki/Architecture_of_Windows_NT) okuyabilirsiniz). Bu alt sistem, win32k.sys (kernel mode), winsrv.dll (user mode) ve csrss.exe (user mode) içerir.

Smss.exe, işletim sistemi için ayrılan Session 0'da csrss.exe ve wininit.exe gibi bileşenleri başlatır. Ayrıca, kullanıcıların erişimine açık olan Session 1 için csrss.exe ve winlogon.exe'i çalıştırır. İlk oluşturulan alt süreç (child instance), smss.exe'nin kendisini yeni bir oturuma kopyalayıp daha sonra kendini sonlandırması ile yeni oturumlar oluşturur. Bu process ile ilgili daha fazla bilgiye [buradan](https://en.wikipedia.org/wiki/Session_Manager_Subsystem) ulaşabilirsiniz.

**Session 0 (csrss.exe & wininit.exe)**

![Smss.exe session 0.](https://assets.tryhackme.com/additional/windows-processes/smss-session0-tree.png)

![csrss.exe properties on session 0.](https://assets.tryhackme.com/additional/windows-processes/smss-session0b.png)

**Session 1 (csrss.exe & winlogon.exe)**

![Smss.exe session 1.](https://assets.tryhackme.com/additional/windows-processes/smss-session1-tree.png)

![csrss.exe properties on session 1.](https://assets.tryhackme.com/additional/windows-processes/smss-session1b.png)

`HKLM\System\CurrentControlSet\Control\Session Manager\Subsystems` altında `Required` değerinde listelenen diğer alt sistemler de başlatılır.

![Smss Registry.](https://assets.tryhackme.com/additional/windows-processes/smss-registry.png)

SMSS ayrıca ortam değişkenleri oluşturmak, sanal bellek sayfalama dosyaları oluşturmak ve winlogon.exe'i (Windows Giriş Yöneticisi) başlatmakla da sorumludur.

**Normal olan nedir?**

![Smss.exe properties.](https://assets.tryhackme.com/additional/windows-processes/smss.png)

**Image Path**: %SystemRoot%\\System32\\smss.exe

**Parent Process**: System

**Number of Instances**: Bir ana instance ve her oturum için bir child instance. Oturumu yarattıktan sonra child instance sonlanır.

**User Account**: Local System

**Start Time**: Ana instance için başlangıç zamanı, sistem başlatılırken saniyeler içinde.

**Alışılmadık olan nedir?**

- System (4) dışında farklı bir parent process
- Image path'in C:\\Windows\\System32'den farklı olması
- Bir oturumdan fazla çalışan process. (child'lar yeni oturumdan sonra kendini sonlandırır)
- Çalışan kullanıcının SYSTEM kullanıcısı olmaması
- Subsystem için beklenmeyen kayıt defteri girdileri



Session 1'de csrss.exe dışında smss.exe tarafından hangi process başlatılır?

{% enddrawer %}

{% drawer Task 5 csrss.exe %}

Önceki bölümde bahsedildiği gibi, **csrss.exe** (**Client Server Runtime Process**) Windows alt sisteminin user-mode tarafıdır. Bu process her zaman çalışır ve sistem operasyonu için kritik öneme sahiptir. Bu process yanlışlıkla sonlandırılırsa, sistem başarısızlığına neden olur. Bu process, Win32 konsol penceresi ve process thread oluşturma ve silme işlemlerinden sorumludur. Her instance için csrsrv.dll, basesrv.dll ve winsrv.dll yüklenir (diğerleriyle birlikte).

Bu process ayrıca, diğer process'lerin Windows API'sine erişimini sağlamak, sürücü harflerini eşleştirmek ve Windows kapatma işlemini yönetmekten de sorumludur. Bu process hakkında daha fazla bilgiyi [buradan](https://en.wikipedia.org/wiki/Client/Server_Runtime_Subsystem) okuyabilirsiniz.

**Not**: Smss.exe, başlangıçta Session 1 için csrss.exe ve winlogon.exe'i çağırır.

**Normal olan nedir?**

**Session 0 (PID 392)**

![csrss.exe session 0 image.](https://assets.tryhackme.com/additional/windows-processes/csrss-session0.png)

**Session 1 (PID 512)**

![csrss.exe session 1 image.](https://assets.tryhackme.com/additional/windows-processes/csrss-session1.png)

Bu iki process için gösterilen parent process'e dikkat edin. Bu process'ler, kendini sonlandıran smss.exe tarafından başlatılır.

**Image Path**: %SystemRoot%\\System32\\csrss.exe

**Parent Process**: Smss.exe tarafından oluşturulan bir instance

**Number of Instances**: İki veya daha fazla

**User Account**: Local System

**Start Time**: İlk iki instance için başlangıç zamanı, sistem başlatıldıktan saniyeler sonra (Session 0 ve 1 için). Ek instance'ların başlangıç zamanları, yeni oturumlar oluşturuldukça gerçekleşir, ancak genellikle yalnızca Session 0 ve 1 oluşturulur.

**Alışılmadık olan nedir?**

- Gerçek bir parent process. (smss.exe bu process'i çağırır ve kendini sonlandırır)
- Image dosya yolu C:\\Windows\\System32 dışında olması
- csrss.exe olarak gizlenmeye çalışan sahte process'lerin hafif yazım hataları
- Kullanıcının SYSTEM kullanıcısı olmaması



PID 384 ve PID 488 olan process hangisiydi?

{% enddrawer %}

{% drawer Task 6 wininit.exe %}

**Windows Initialization Process**, **wininit.exe**, Service Control Manager (services.exe), Local Security Authority (lsass.exe) ve Credential Guard ile KeyGuard'a ilişkin lsaiso.exe'i Session 0'da başlatan başka bir kritik Windows process'idir. Bu process ve çocuk process'leri arka planda çalışır.

![Wininit.exe process tree.](https://assets.tryhackme.com/additional/windows-processes/wininit-tree.png)

Not: lsaiso.exe, **Credential Guard ve KeyGuard** ile ilişkilendirilmiş bir process'tir. Bu process'i yalnızca Credential Guard etkinleştirilmişse görebilirsiniz.

**Normal olan nedir?**

![Wininit.exe properties.](https://assets.tryhackme.com/additional/windows-processes/wininit.png)

**Image Path**: %SystemRoot%\\System32\\wininit.exe

**Parent Process**: smss.exe tarafından oluşturulan bir instance

**Number of Instances**: Bir

**User Account**: Local System

**Start Time**: Başlangıç zamanı, sistem açılışından saniyeler içinde

**Alışılmadık Durumlar Nelerdir?**

- Gerçekten var olan bir parent process. (smss.exe bu process'i başlatır ve ardından kendini sonlandırır.)
- Image dosya yolu C:\\Windows\\System32'nin dışında olması.
- Sahte process'leri gizlemek için yapılan küçük yazım hataları.
- Tek bir instance yerine birden fazla instance'ın çalışıyor olması.
- Process'in SYSTEM kullanıcısı altında çalışmaması.



Credential Guard etkin değilse hangi process'i çalışırken görmeyebilirsiniz?

{% enddrawer %}

{% drawer Task 7 wininit.exe > services.exe %}

Bir sonraki process **Service Control Manager** (SCM) veya **services.exe**'dir. Bu process'in temel sorumluluğu, sistem servislerini yönetmektir: servisleri yüklemek, servislerle etkileşim kurmak ve servisleri başlatmak veya sonlandırmak. Bir veritabanını sürdürür ve bu veritabanı Windows'a yerleşik bir yardımcı program olan `sc.exe` ile sorgulanabilir.

```
C:\\Users\\Administrator> sc.exe
DESCRIPTION:
        SC is a command line program used for communicating with the
        Service Control Manager and services.
USAGE:
        sc <server> [command] [service name] <option1> <option2>...
```

Servislerle ilgili bilgiler, `HKLM\\System\\CurrentControlSet\\Services` kayıt defterinde saklanır.

![Service Registry.](https://assets.tryhackme.com/additional/windows-processes/services-registry.png)

Bu process ayrıca, otomatik başlama olarak işaretlenmiş aygıt sürücülerini hafızaya yükler.

Bir kullanıcı başarıyla makineye giriş yaptığında, bu process, Last Known Good control set'in değerini (Last Known Good Configuration), `HKLM\\System\\Select\\LastKnownGood`, CurrentControlSet ile değiştirerek ayarlar.

![LastKnownGood Registry Key.](https://assets.tryhackme.com/additional/windows-processes/lastknowngood.png)

Bu process ayrıca birkaç anahtar process'in ebeveynidir: svchost.exe, spoolsv.exe, msmpeng.exe ve dllhost.exe gibi birkaçını sayabiliriz. Bu process hakkında daha fazla bilgiyi [buradan](https://en.wikipedia.org/wiki/Service_Control_Manager) okuyabilirsiniz.

![Services.exe process tree.](https://assets.tryhackme.com/additional/windows-processes/services-tree.png)

**Normal olan nedir?**

![Services.exe properties.](https://assets.tryhackme.com/additional/windows-processes/services.png)

![Services.exe properties (2).](https://assets.tryhackme.com/additional/windows-processes/services2.png)

**Image Path**: %SystemRoot%\\System32\\services.exe

**Parent Process**: wininit.exe

**Number of Instances**: Bir

**User Account**: Local System

**Start Time**: Başlangıç zamanı, sistem açılışından saniyeler içinde

**Alışılmadık Durumlar Nelerdir?**

- Parent process'in wininit.exe olmaması.
- Image dosya yolunun C:\Windows\System32 dışında olması.
- Sahte process'lerin gizlenmesi için kullanılan hafif yazım hataları.
- Tek bir instance yerine birden fazla instance'ın çalışıyor olması.
- Process'in SYSTEM kullanıcısı altında çalışmaması.

{% enddrawer %}

---
> Bir Windows sisteminde 1 adet ``services.exe`` çalışıyor olmalı
{: .prompt-danger }

{% drawer Task 8 wininit.exe > services.exe > svchost.exe %}

**Service Host** (Windows Hizmetleri için Ana Bilgisayar Süreci) veya **svchost.exe**, Windows hizmetlerini barındırmaktan ve yönetmekten sorumludur.

![Svchost.exe process tree.](https://assets.tryhackme.com/additional/windows-processes/dcomlaunch.png)

Bu süreçte çalışan hizmetler DLL olarak uygulanır. İlgili hizmet için DLL, `ServiceDLL` adında `Parameters` alt anahtarında kaydedilir. Tam yol `HKLM\SYSTEM\CurrentControlSet\Services\SERVICE NAME\Parameters` şeklindedir.

Aşağıda, Dcomlaunch hizmeti için ServiceDLL değeri verilmiştir.

![DCOMLaunch Registry.](https://assets.tryhackme.com/additional/windows-processes/servicedll.png)

Process Hacker içinden bu bilgiyi görüntülemek için, svchost.exe sürecine sağ tıklayın. Bu durumda, PID 748 olacaktır.

![DCOMLaunch service.](https://assets.tryhackme.com/additional/windows-processes/dcomlaunch2.png)

Hizmete sağ tıklayın ve Özellikler'i seçin. Service DLL'e bakın.

![DCOMLaunch service information.](https://assets.tryhackme.com/additional/windows-processes/dcomlaunch3.png)

Yukarıdaki ekran görüntüsünden, Binary Path listelenmiştir.

Ayrıca, nasıl yapılandırıldığına dikkat edin. Binary Path'te bir anahtar tanımlayıcı bulunur ve bu tanımlayıcı `-k`'dır. Bu, meşru bir svchost.exe sürecinin nasıl çağrıldığını gösterir.

`-k` parametresi, benzer hizmetlerin aynı süreci paylaşmasını sağlamak için kullanılır. Bu kavram, işletim sistemi tasarımına dayanarak uygulanmış ve kaynak tüketimini azaltmak amacıyla geliştirilmiştir. **Windows 10 Sürüm 1703'ten** itibaren, gruplandırılan hizmetlerde değişiklik yapıldı. 3,5 GB'dan fazla belleği olan makinelerde, her hizmet kendi sürecinde çalışacaktır. Bu süreç hakkında daha fazla bilgiyi [buradan](https://en.wikipedia.org/wiki/Svchost.exe) okuyabilirsiniz.

Binary Path'teki anahtar tanımlayıcıya (-k) geri dönüldüğünde, yukarıdaki ekranda -k değeri **Dcomlaunch**'tur. Sanal makinede aynı ikili yolu paylaşan diğer hizmetler de çalışmaktadır.

![DCOMLaunch parameter.](https://assets.tryhackme.com/additional/windows-processes/shared-process.png)

Her biri, ServiceDLL için farklı bir değere sahip olacak. Örnek olarak LSM'yi alalım ve ServiceDLL değerini inceleyelim.

![LSM Registry.](https://assets.tryhackme.com/additional/windows-processes/lcm.png)

![LSM Properties.](https://assets.tryhackme.com/additional/windows-processes/lcm2.png)

Svchost.exe, herhangi bir Windows sistemde her zaman birden fazla süreç çalıştırdığından, bu süreç kötü amaçlı kullanım için bir hedef olmuştur. Kötü niyetli kişiler, bu süreci taklit eden zararlı yazılımlar yaratır ve meşru svchost.exe süreçleri arasında gizlenmeye çalışır. Zararlı yazılımı svchost.exe olarak adlandırabilir veya basit yazım yanlışları yapabilirler, örneğin scvhost.exe olarak. Bunu yaparak, radarın altında kalmayı amaçlarlar. Bir başka taktik ise kötü niyetli bir hizmeti (DLL) yüklemek veya çağırmaktır.

Ek kaynak - [Hexacorn Blog](https://www.hexacorn.com/blog/2015/12/18/the-typographical-and-homomorphic-abuse-of-svchost-exe-and-other-popular-file-names/)

**Normal olan nedir?**

![Svchost.exe properties.](https://assets.tryhackme.com/additional/windows-processes/svchost.png)

**Image Path**: %SystemRoot%\\System32\\svchost.exe

**Parent Process**: services.exe

**Number of Instances**: Birçok

**User Account**: Kullanıcı hesabı svchost.exe örneğine bağlı olarak değişir (SYSTEM, Network Service, Local Service). Windows 10'da bazı örnekler giriş yapmış kullanıcı olarak çalışır.

**Start Time**: Tipik olarak başlangıç zamanı, sistem açılışından saniyeler sonra. Diğer svchost.exe örnekleri açılıştan sonra başlatılabilir.

**Alışılmadık Durumlar Nelerdir?**

- Parent process olarak services.exe dışında bir sürecin olması.
- Image dosya yolunun C:\\Windows\\System32 dışında yer alması.
- Sahte süreçlerin gizlenmesi için yapılan küçük yazım hataları.
- -k parametresinin bulunmaması.



**Command line** veya **Binary path**'te her zaman görünmesi gereken tek harfli parametre nedir?

{% enddrawer %}

{% drawer Task 9 lsass.exe %}

Wikipedia'ya göre, "Local Security Authority Subsystem Service" (**LSASS**), Microsoft Windows işletim sistemlerinde güvenlik politikasını uygulamaktan sorumlu bir süreçtir. Bu süreç, Windows bilgisayarlara veya sunuculara giriş yapan kullanıcıları doğrular, şifre değişikliklerini yönetir ve erişim token'ları oluşturur. Ayrıca, Windows Güvenlik Günlüğü'ne yazılar ekler.

Güvenlik token'ları, SAM (Security Account Manager), AD (Active Directory) ve NETLOGON için üretilir. Kullanılan kimlik doğrulama paketleri, `HKLM\System\CurrentControlSet\Control\Lsa` altında belirtilir.

![LSA Registry.](https://assets.tryhackme.com/additional/windows-processes/lsa.png)

Lsass.exe, zararlı yazılımların sıklıkla hedef aldığı bir süreçtir. Kimlik bilgilerini çalmak için **Mimikatz** gibi araçlar kullanılır veya zararlılar, bu süreci taklit ederek gizlenmeye çalışır. Bunlar, sürecin adını kullanarak veya adını hafifçe yanlış yazarak (örneğin, lsaas.exe) yaparlar.

**Ek Okuma**: [LSASS'ın kötü amaçlı olarak nasıl kullanıldığı ve Microsoft'un bu tür saldırıları önlemek için aldığı önlemler](https://yungchou.wordpress.com/2016/03/14/an-introduction-of-windows-10-credential-guard/).

**Normal Durum Nedir?**

![Lsass.exe properties.](https://assets.tryhackme.com/additional/windows-processes/lsass.png)

**Image Path**: %SystemRoot%\\System32\\lsass.exe

**Parent Process**: wininit.exe

**Number of Instances**: Tek

**User Account**: Local System

**Start Time**: Sistem açılışından hemen sonra

**Alışılmadık Durum Nedir?**

- wininit.exe dışında bir parent process olması
- Image dosya yolunun C:\\Windows\\System32 dışında olması
- Sahte süreçleri gizlemek için yapılan küçük yazım hataları
- Birden fazla instance çalışması
- SYSTEM kullanıcısı altında çalışmaması



LSASS için parent process nedir?

{% enddrawer %}

{% drawer Task 10 winlogon.exe %}

**Windows Logon**, **winlogon.exe**, kullanıcıların kullanıcı adı ve şifrelerini girmeleri için gereken ALT+CTRL+DELETE tuş kombinasyonu ile, yani **Secure Attention Sequence** (SAS) ile sorumludur.

Bu süreç aynı zamanda kullanıcı profilini yüklemekten de sorumludur. Kullanıcının NTUSER.DAT dosyasını HKCU'ya yükler ve userinit.exe kullanıcının arayüzünü yükler. Bu süreç hakkında daha fazla bilgi [buradan](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc939862(v=technet.10)?redirectedfrom=MSDN) edinebilirsiniz.

![Winlogon Registry.](https://assets.tryhackme.com/additional/windows-processes/winlogon-registry.png)

Ek olarak, ekran kilitleme ve kullanıcının ekran koruyucusunu çalıştırma gibi işlevlerden sorumludur. Bu süreç hakkında daha fazla bilgi [buradan](https://en.wikipedia.org/wiki/Winlogon) edinebilirsiniz.

Daha önceki bölümlerden hatırlayacağınız üzere, smss.exe bu süreci Session 1 içinde csrss.exe'nin bir kopyası ile birlikte başlatır.

![Winlogon child processes.](https://assets.tryhackme.com/additional/windows-processes/winlogon-tree.png)

**Normal Durum Nedir?**

![Winlogon properties.](https://assets.tryhackme.com/additional/windows-processes/winlogon1.png)

![Winlogon properties (2).](https://assets.tryhackme.com/additional/windows-processes/winlogon2.png)

**Image Path**: %SystemRoot%\\System32\\winlogon.exe

**Parent Process**: Smss.exe tarafından başlatılan bir instance tarafından oluşturulur, bu nedenle analiz araçları genellikle parent process adını sağlamaz.

**Number of Instances**: Bir veya daha fazla

**User Account**: Local System

**Start Time**: İlk instance için başlangıç zamanı, Session 1 için sistem açılışından saniyeler sonra. Ek instance'lar, yeni oturumlar oluşturuldukça gerçekleşir, genellikle Uzak Masaüstü veya Hızlı Kullanıcı Değiştirme girişleri yoluyla.

**Alışılmadık Durum Nedir?**

- Gerçek bir parent process olması. (smss.exe bu süreci çağırır ve kendini sonlandırır)
- Image dosya yolu C:\\Windows\\System32 dışında olması
- Sahte süreçleri saklamak için yapılan hafif yazım hataları
- SYSTEM olarak çalışmaması
- Kayıt defterindeki Shell değeri explorer.exe dışında olması



winlogon.exe için olmayan parent process nedir?

{% enddrawer %}

{% drawer Task 11 explorer.exe %}

Son olarak inceleyeceğimiz süreç **Windows Explorer**, yani **explorer.exe**'dir. Bu süreç, kullanıcılara dosya ve klasörlerine erişim sağlar. Ayrıca Başlat Menüsü ve Görev Çubuğu gibi diğer özellikler için de işlevsellik sunar.

Daha önce bahsedildiği gibi, Winlogon süreci, `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell` değerindeki userinit.exe'yi çalıştırır. Userinit.exe, explorer.exe'yi başlattıktan sonra sonlanır. Bu nedenle, parent process mevcut değildir.

Explorer.exe için birçok child process olacaktır.

![Explorer.exe child processes.](https://assets.tryhackme.com/additional/windows-processes/explorer-tree.png)

**Normal Olan Nedir?**

![Explorer.exe properties.](https://assets.tryhackme.com/additional/windows-processes/explorer.png)

**Image Path**: %SystemRoot%\\explorer.exe

**Parent Process**: Userinit.exe tarafından oluşturulur ve sonlanır

**Number of Instances**: Etkileşimli olarak giriş yapan her kullanıcı için bir veya daha fazla

**User Account**: Giriş yapmış kullanıcı(lar)

**Start Time**: İlk etkileşimli kullanıcı oturumu başladığında ilk instance

**Alışılmadık Olan Nedir?**

- Gerçek bir parent process olması. (userinit.exe bu süreci çağırır ve sonlanır)
- Image dosya yolu C:\\Windows dışında olması
- Bilinmeyen bir kullanıcı olarak çalışması
- Sahte süreçleri saklamak için yapılan hafif yazım hataları
- Giden TCP/IP bağlantıları

![Explorer.exe properties view.](https://assets.tryhackme.com/additional/windows-processes/explorer-tcpip.png)

**Not**: Yukarıdaki görüntü, Process Explorer'dan explorer.exe özellikler görünümüdür.



Explorer.exe için olmayan süreç nedir?

{% enddrawer %}

{% drawer Task 12 Conclusion %}

Windows işletim sisteminin bir savunucu olarak nasıl işlediğini anlamak hayati önem taşır. Bu odada tartışılan Windows süreçleri, çekirdek süreçlerdir ve bu süreçlerin genellikle nasıl çalıştığını anlamak, bir savunucunun uç noktadaki alışılmadık aktiviteleri tespit etmesine yardımcı olabilir.

Windows 10'un tanıtımıyla, normal davranışları bilinmesi ve anlaşılması gereken çekirdek süreçler listesine yeni süreçler eklendi.

Daha önce bahsedildiği gibi, uç noktada Credential Guard etkinleştirilmişse, wininit.exe'ye child process olarak çalışacak ek bir süreç olacaktır ve bu süreç lsaiso.exe'dir. Bu süreç, uç noktada şifre korumasını güçlendirirken lsass.exe ile birlikte çalışır.

Windows 10 ile diğer süreçler arasında RuntimeBroker.exe ve taskhostw.exe (daha önce **taskhost.exe** ve **taskhostex.exe** olarak bilinir) bulunur.

Bu odanın bilgileri birden fazla kaynaktan türetilmiştir.

- [https://0xcybery.github.io/blog/Core-Processes-In-Windows-System](https://0xcybery.github.io/blog/Core-Processes-In-Windows-System)
- [https://www.sans.org/posters/hunt-evil/](https://www.sans.org/posters/hunt-evil/)
- [https://docs.microsoft.com/en-us/sysinternals/resources/windows-internals](https://docs.microsoft.com/en-us/sysinternals/resources/windows-internals)

{% enddrawer %}

## Sysinternals

{% drawer Task 1 Introduction %}

Bu bölümde, bir sanal makineyi dağıtarak başlayacağız. **Sysinternals** araçları nedir?

Sysinternals araçları, 70'den fazla Windows tabanlı aracı kapsayan bir koleksiyondur. Bu araçlar aşağıdaki kategorilere ayrılır:

- Dosya ve Disk Yardımcı Programları
- Ağ Yardımcı Programları
- İşlem Yardımcı Programları
- Güvenlik Yardımcı Programları
- Sistem Bilgisi
- Çeşitli

Sysinternals araçları ve websitesi (sysinternals.com), Mark Russinovich ve Bryce Cogswell tarafından 90'ların sonlarında, Wininternals Software şirketi altında oluşturuldu.

2006 yılında Microsoft, Wininternals Software'ı satın aldı ve Mark Russinovich Microsoft'a katıldı. Bugün o, Microsoft Azure'un CTO'su.

Mark Russinovich, 2005 yılında Sony'nin müzik CD'lerine rootkit yerleştirdiğini açıkladığında gündeme geldi. Bu keşif, test etmekte olduğu Sysinternals araçlarından biri sayesinde ortaya çıktı. Bu konuda daha fazla bilgiyi [buradan](https://www.virusbulletin.com/virusbulletin/2005/12/inside-sony-s-rootkit) okuyabilirsiniz.

{% drawer rootkit  %}
Bir bilgisayar sistemine gizlice sızan ve sistemin işleyişini kullanıcılardan ve diğer programlardan saklayan kötü amaçlı bir yazılımdır.


{% enddrawer %}

Ayrıca, 2006 yılında Symantec'in rootkit benzeri teknoloji kullandığını keşfetti. Bu konuda daha fazla bilgiyi [buradan](https://www.zdnet.com/article/symantec-confesses-to-using-rootkit-technology/) okuyabilirsiniz.

Sysinternals araçları, Windows sistemlerini yöneten BT profesyonelleri arasında son derece popülerdir. Bu araçlar o kadar popülerdir ki, kırmızı takım üyeleri ve düşmanlar tarafından da kullanılmaktadır. Bu odada, düşmanlar tarafından kullanılan araçları hangilerinin olduğunu MITRE'ın belirlediğini not edeceğim.

![Screenshot showing Remmina remote desktop preferences](https://assets.tryhackme.com/additional/win-event-logs/remmina.png)

{% enddrawer %}

{% drawer Task 2 Install the Sysinternals Suite %}

Sysinternals araçları ile çalışma zamanı geldi.

Sysinternals araçları, yerel sistemden indirilip çalıştırılabilir veya web üzerinden doğrudan kullanılabilir.

Tüm paketi indirmek istemiyorsanız, sadece birkaç araç indirmek için **Sysinternals Utilities Index** [sayfasına](https://docs.microsoft.com/en-us/sysinternals/downloads) gidin.

![Screenshot showing the webpage of Sysinternals Utilities Index](https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/87a25829f06c629a47f269fb1650339a.png)

Alternatif olarak, araçları bulup indirmek için kategori bağlantılarını kullanabilirsiniz. Bu yöntem, çok sayıda araç olduğu için, tüm dizini yerine ilgilendiğiniz araçlara odaklanmanıza yardımcı olur.

Örneğin, Windows süreçlerini incelemek için araçlara ihtiyacınız varsa, bu kategori altındaki tüm araçlar için **Process Utilities** sayfasına gidin, [https://docs.microsoft.com/en-us/sysinternals/downloads/process-utilities/](https://docs.microsoft.com/en-us/sysinternals/downloads/process-utilities/).

![Screenshot showing the webpage of Sysinternals Process Utilities](https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/9b077a2ec0682837f2f31e48c357c94e.png)

Son olarak, Sysinternals Live URL'si üzerinden de aynı işlemleri yapabilirsiniz, [https://live.sysinternals.com/](https://live.sysinternals.com/). Araçları web üzerinden çalıştırmak istiyorsanız bu URL'yi kullanabilirsiniz. Bu işlemi nasıl yapacağımıza bir sonraki bölümde bakacağız.

![Screenshot showing the webpage of live.sysinternals.com](https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/dc610f4def1a7cf4e10a365fb1cf9e22.png)

Sysinternals Suite'i indirmek isterseniz, zip dosyasını [buradan](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite) indirebilirsiniz.

Suite, belirli sayıda Sysinternal aracını içerir. Suite'te yer alan araçların bir listesi aşağıda verilmiştir.

![Screenshot showing the tools included in the Sysinternals Suite](https://assets.tryhackme.com/additional/sysinternals/sysint-suite.png)

Zip dosyasını indirdikten sonra, dosyaları çıkartmanız gerekecek. Dosyalar çıkarıldıktan sonra, isteğe bağlı bir ek adım olarak, araçların bulunduğu klasör yolunu ortam değişkenlerine ekleyebilirsiniz. Böylece araçları, araçların bulunduğu dizine gitmeden komut satırı üzerinden başlatabilirsiniz.

**Ortam Değişkenleri**, **Sistem Özellikleri**'nden düzenlenebilir.

Sistem Özellikleri, `sysdm.cpl` komutunu çalıştırarak komut satırı üzerinden başlatılabilir. **Advanced** sekmesine tıklayın.

![Screenshot showing MS Windows System Properties Advanced tab](https://assets.tryhackme.com/additional/sysinternals/env-variables.png)

**System Variables** altında **Path** seçeneğini bulun ve **Edit...** ardından **OK**'ı seçin.

![Screenshot showing the Path variable under System Variables](https://assets.tryhackme.com/additional/sysinternals/env-variables2.png)

Sonraki ekranda **New** seçeneğini seçin ve Sysinternals Suite'in çıkarıldığı klasör yolunu girin. Değişiklikleri onaylamak için **OK**'a basın.

![Screenshot showing the addition of a new directory under the Path variable](https://assets.tryhackme.com/additional/sysinternals/env-variables3.png)

Yeni bir komut istemi (yüksek yetkili) açarak Sysinternals Suite'in herhangi bir yerden çalıştırılabildiğini doğrulayın.

![Screenshot showing the Process Monitor tool started from the command prompt](https://assets.tryhackme.com/additional/sysinternals/env-variables4.png)

Yerel bir Sysinternals Suite kopyası `C:\Tools\Sysint` konumunda bulunmaktadır.

Alternatif olarak, bir PowerShell modülü tüm Sysinternals araçlarını indirebilir ve kurabilir.

- PowerShell komutu: `Download-SysInternalsTools C:\Tools\Sysint`

Şimdi, Sysinternals araçlarını web üzerinden nasıl çalıştıracağımıza bakalım.

Sysinternals Suite içinde listelenen son araç nedir?

{% enddrawer %}

{% drawer Task 3 Using Sysinternals Live %}

Sysinternals web sitesine göre, "Sysinternals Live, Sysinternals araçlarını web üzerinden doğrudan yüklemek zorunda kalmadan çalıştırmanızı sağlayan bir hizmettir. Bir aracın Sysinternals Live yolunu Windows Gezgini'ne veya bir komut istemine `live.sysinternals.com/<toolname>` veya `\\live.sysinternals.com\tools\<toolname>` olarak girerek aracı doğrudan çalıştırabilirsiniz."

Bu işlemi nasıl yapacağımıza bakalım.

Talimatlar doğrultusunda, web üzerinden Process Monitor'u başlatmak için kullanılacak sözdizimi `\\live.sysinternals.com\tools\procmon.exe`'dir.

Ve bu başarısız olur.

![Screenshot showing the error: cannot find the path specified](https://assets.tryhackme.com/additional/sysinternals/sysint-live-fail.png)

Bu sorunu çözmek için, WebDAV istemcisinin makinede yüklü ve çalışır durumda olması gerekir. WebDAV protokolü, yerel bir makinenin uzaktaki bir makineye WebDAV paylaşımı üzerinden erişmesine ve işlem yapmasına olanak tanır.

Windows 10 istemcisinde, WebDAV istemcisi yüklüdür ancak büyük olasılıkla çalışmıyor. Bir Sysinternals aracını çalıştırmayı denediğinizde "The network path was not found." mesajıyla başarısız olacaktır.

![Screenshot showing the steps to start the webclient service and fix the error: the network path was not found](https://assets.tryhackme.com/additional/sysinternals/win10-webclient1b.png)

Herhangi bir Sysinternals aracını bu şekilde çağırmadan önce servisin başlatılmış olması gerekmektedir.

![Screenshot showing the command prompt executing get-service webclient](https://assets.tryhackme.com/additional/sysinternals/win10-webclient2.png)

Devam etmeden önce çalıştığını doğrulayın.

![Screenshot showing the command prompt executing get-service webclient and confirming that it is Running](https://assets.tryhackme.com/additional/sysinternals/win10-webclient3.png)

Ayrıca, **Network Discovery** de etkinleştirilmelidir. Bu ayar, **Network and Sharing Center**'de etkinleştirilebilir.

Ağ ve Paylaşım Merkezi'ni açmanın birkaç yolu vardır. İşte bunu başlatmak için kullanışlı bir komut satırı:

```
control.exe /name Microsoft.NetworkAndSharingCenter
```
![Screenshot showing the command prompt used to open the Network and Sharing Center](https://assets.tryhackme.com/additional/sysinternals/network-and-sharing.png)

`Change advanced sharing settings` seçeneğine tıklayın ve mevcut ağ profiliniz için `Turn on network discovery` seçeneğini belirleyin.

Bağlı VM, Windows Server 2019 sürümüdür. WebDAV istemcisi varsayılan olarak yüklü değildir.

Windows Server'da yüklenmesi gereken özellik **WebDAV Redirector**'dir. Bu özellik, **Server Manager** veya **PowerShell** kullanılarak yüklenebilir.

PowerShell ile yüklemek için, `Install-WindowsFeature WebDAV-Redirector –Restart` komutunu kullanın. Kurulumun tamamlanması için sunucunun yeniden başlatılması gerekmektedir.

Yeniden başlatmadan sonra, kurulum aşağıdaki PowerShell komutu ile doğrulanabilir, `Get-WindowsFeature WebDAV-Redirector | Format-Table –Autosize`.

![Screenshot showing the command prompt used to verify the installation of WebDAV Redirector](https://assets.tryhackme.com/additional/sysinternals/win2019-webclient1.png)

Bu noktadan itibaren Windows 10 istemcisiyle aynı süreç geçerlidir:

- WebClient servisinin çalıştığından emin olun
- **Network Discovery** etkinleştirildiğinden emin olun

Gerekli tüm bileşenler kurulduğu ve etkinleştirildiği zaman yerel makine web üzerinden Sysinternals araçlarını çalıştırmaya hazırdır.

Araçları çalıştırmanın iki yolu vardır:

1. Yöntem - Komut satırından aracı çalıştırın

![Screenshot showing a Sysinternals tool started from the command line](https://assets.tryhackme.com/additional/sysinternals/win2019-method1.png)

2. Yöntem - Ağ sürücüsü oluşturun ve haritalanan sürücüden aracı çalıştırın

![Screenshot showing how drive Y is connected to live.sysinternals.com\tools](https://assets.tryhackme.com/additional/sysinternals/win2019-method2a.png)

**Not**: Yıldız işareti, otomatik olarak bir sürücü harfi atar. Yıldız işareti, gerçek bir sürücü harfi ile değiştirilebilir.

![Screenshot showing drive Y among the Network locations](https://assets.tryhackme.com/additional/sysinternals/win2019-method2b.png)

Web sitesi artık yerel makinede gezilebilir.

![Screenshot browsing drive Y via the command prompt](https://assets.tryhackme.com/additional/sysinternals/win2019-method2c.png)

![Screenshot showing the help page launched from the command prompt for the Process Monitor tool.](https://assets.tryhackme.com/additional/sysinternals/win2019-method2d.png)

Yerel makinede live.sysinternals.com ile etkileşim kurmak için hangi servisin etkinleştirilmesi gerekmektedir?

{% enddrawer %}

{% drawer Task 4 File and Disk Utilities %}

Bu bölümde, her görevde bir veya iki Sysinternals aracına odaklanacağız, bazen daha fazlasına.

Tekrar belirtmek gerekirse, amacımız Sysinternals araçlarını tanıtmak, ancak her bir aracı detaylı bir şekilde incelemek için fazla sayıda araç var.

**Sigcheck**

"**Sigcheck** bir komut satırı yardımcı programıdır ve dosya sürüm numarası, zaman damgası bilgisi ve dijital imza detaylarını, sertifika zincirleri dahil olmak üzere gösterir. Ayrıca, bir dosyanın durumunu VirusTotal'da kontrol etme ve dosyayı tarama için yükleme seçeneği içerir." (**resmi tanım**)

![Screenshot showing the execution of sigcheck using the command prompt](https://assets.tryhackme.com/additional/sysinternals/sigcheck1.png)  

Resmi Sigcheck [sayfasında](https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck), sayfanın altında bir kullanım durumu belirtilmiştir.

Eğer Core Windows Processes odasını tamamladıysanız, tüm yürütülebilir dosyaların `C:\Windows\System32` konumunda olduğunu, **Explorer.exe**'nin ise (`C:\Windows`) olduğunu bilmelisiniz.

Kullanım Durumu: C:\\Windows\\System32'deki imzasız dosyaları kontrol edin.

Komut: `sigcheck -u -e C:\Windows\System32`

![Screenshot showing the execution of sigcheck against the c:\Windows\system32 directory](https://assets.tryhackme.com/additional/sysinternals/sigcheck2.png)  

Parametre kullanımı:

- `-u` "VirusTotal kontrolü etkinse, VirusTotal tarafından bilinmeyen veya sıfırdan farklı tespit olan dosyaları göster, aksi takdirde sadece imzasız dosyaları göster."
- `-e` "Yalnızca yürütülebilir görüntüleri tara (uzantılarına bakılmaksızın)"

**Not**: Eğer sonuçlar farklıysa, listelenen yürütülebilir dosyalar hakkında bir inceleme yapılması gerekebilir.

**Streams**

"NTFS dosya sistemi, uygulamaların alternatif veri akışları oluşturmasına olanak tanır. Varsayılan olarak, tüm veriler bir dosyanın ana adlandırılmamış veri akışında saklanır, ancak 'dosya:akış' sözdizimini kullanarak alternatiflere okuma ve yazma yapabilirsiniz." (**resmi tanım**)

Alternatif Veri Akışları (ADS), Windows NTFS (New Technology File System) için özgü bir dosya özelliğidir. Her dosya en az bir veri akışına ($DATA) sahiptir ve ADS, dosyaların birden fazla veri akışı içermesine olanak tanır. Yerel Windows Gezgini ADS'yi kullanıcıya göstermez. Bu verileri görüntülemek için üçüncü parti yürütülebilir dosyalar kullanılabilir, ancak PowerShell, dosyalar için ADS'yi görüntülemenize olanak tanır.

Zararlı yazılım yazarları, ADS'yi bir endpoint'te veri gizlemek için kullanmıştır, ancak tüm kullanımları kötü niyetli değildir. İnternetten bir endpoint'e dosya indirdiğinizde, indirildiği yer olarak Internet'ten geldiğini belirten tanımlayıcılar ADS'ye yazılır.

![Screenshot showing the execution of streams using the command prompt](https://assets.tryhackme.com/additional/sysinternals/streams1.png)

Örnek: İnternet'ten indirilen bir dosya.

![Screenshot showing the execution of streams against SysinternalsSuite.zip](https://assets.tryhackme.com/additional/sysinternals/streams2.png)

Bu tanımlayıcılar dosyanın özelliklerine ek güvenlik önlemleri eklenmesine neden olur.

![Screenshot showing the file properties of SysinternalsSuite.zip](https://assets.tryhackme.com/additional/sysinternals/streams3.png)

Streams hakkında daha fazla bilgiyi [buradan](https://docs.microsoft.com/en-us/sysinternals/downloads/streams) okuyabilirsiniz.

**SDelete**

"**SDelete**, bir dizi seçenek sunan bir komut satırı yardımcı programıdır. Her kullanımda, bir veya daha fazla dosya ve/veya dizini silmenize veya mantıksal bir diskin boş alanını temizlemenize olanak tanır."

Resmi belge sayfasına göre, SDelete (Güvenli Silme), DOD 5220.22-M (Savunma Bakanlığı temizleme ve sanitasyon protokolü) uygular.

![Screenshot showing the implementation of the DoD 5220.22-M Wipe Method](https://assets.tryhackme.com/additional/sysinternals/sdelete.png)

Kaynak: [https://www.lifewire.com/dod-5220-22-m-2625856](https://www.lifewire.com/dod-5220-22-m-2625856)

SDelete, düşmanlar tarafından kullanılmış ve MITRE teknikleri [T1485](https://attack.mitre.org/techniques/T1485/) (**Veri İmha**) ve [T1070.004](https://attack.mitre.org/techniques/T1070/004/) (**Sunucuda Gösterge Kaldırma: Dosya Silme**) ile ilişkilendirilmiştir. MITRE ID'si [S0195](https://attack.mitre.org/software/S0195/)'dir.

Bu aracı daha derinlemesine incelemek için Sysinternals SDelete [sayfasını](https://docs.microsoft.com/en-us/sysinternals/downloads/sdelete) ziyaret edebilirsiniz.

**Dosya ve Disk Araçları** kategorisi altında diğer araçlar da bulunmaktadır. Bu araçları kendi zamanınızda keşfetmenizi öneririm.

Bağlantı: [https://docs.microsoft.com/en-us/sysinternals/downloads/file-and-disk-utilities](https://docs.microsoft.com/en-us/sysinternals/downloads/file-and-disk-utilities) 

Aşağıdaki soruları yanıtlayın

Masaüstünde `file.txt` adında bir txt dosyası var. Bu görevde tartışılan üç araçtan birini kullanarak, ADS içindeki metin nedir?

{% enddrawer %}

## Osquery: The Basics

{% drawer Task 1 Introduction %}

[Osquery](https://osquery.io/), 2014 yılında [Facebook](https://engineering.fb.com/2014/10/29/security/introducing-osquery/) tarafından oluşturulan [açık kaynak](https://github.com/osquery/osquery) bir ajandır. İşletim sistemini ilişkisel bir veritabanına dönüştürür. SQL sorguları kullanarak tablolar üzerinden sorular sormamıza olanak tanır, örneğin çalışan işlemlerin listesi, ana bilgisayarda oluşturulan kullanıcı hesapları ve belirli şüpheli alanlarla iletişim kuran işlemler gibi. Osquery, Güvenlik Analistleri, Olay Müdahale Uzmanları, Tehdit Avcıları vb. tarafından yaygın olarak kullanılır. Osquery, Windows, Linux, macOS ve FreeBSD gibi çeşitli platformlara kurulabilir.

**Öğrenme Hedefleri:**

Bu giriş odasında aşağıdaki öğrenme hedefleri ele alınacaktır:

- Osquery nedir ve hangi sorunu çözer?
- Osquery İnteraktif Modu
    - Osquery'nin interaktif modunu kullanarak işletim sistemi ile nasıl etkileşim kurulur
    - İki tabloyu birleştirerek tek bir cevap nasıl alınır

**Not:** SQL sorgularına zaten aşina iseniz bu oldukça faydalıdır. Değilse, bu [SQL Eğitimi](https://www.w3schools.com/sql/sql_intro.asp) 'ni inceleyin.

{% enddrawer %}

{% drawer Task 2 Connect with the Lab %}

Görev, dağıtılabilir bir makine içerir

Makineyi Başlat

Bu odaya bağlı sanal makineye Windows ve Linux üzerinde Osquery kurulmuş ve yapılandırılmıştır. Devam etmeden önce, ilişkilendirilmiş VM'i başlatın ve bağlanmak için aşağıdaki kimlik bilgilerini kullanın. VM, sağ tarafta bölünmüş ekranda erişilebilir olacaktır. VM görünmüyorsa, sayfanın sağ üst köşesindeki mavi **Show Split View** düğmesini kullanın.

Görev çubuğuna sabitlenmiş `powershell terminal` 'ini açın ve osquery'nin interaktif moduna girmek için `osqueryi` yazın.

Makine IP: `MACHINE_IP`

Kullanıcı Adı: `James`

Parola: `thm_4n6`

VM'in tamamen açılması 3-5 dakika sürebilir.

{% enddrawer %}

{% drawer Task 3 Osquery: Interactive Mode %}

Osquery ile etkileşime geçmenin yollarından biri interaktif modunu kullanmaktır. Terminali açın ve `osqueryi` komutunu çalıştırın. Aracı anlamak için, interaktif terminalde `.help` komutunu çalıştırın:

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery> .help
Welcome to the osquery shell. Please explore your OS!
You are connected to a transient 'in-memory' virtual database.

.all [TABLE]     Select all from a table
.bail ON|OFF     Stop after hitting an error
.connect PATH    Connect to an osquery extension socket
.disconnect      Disconnect from a connected extension socket
.echo ON|OFF     Turn command echo on or off
.exit            Exit this program
.features        List osquery's features and their statuses
.headers ON|OFF  Turn display of headers on or off
.help            Show this message
.mode MODE       Set output mode where MODE is one of:
                   csv      Comma-separated values
                   column   Left-aligned columns see .width
                   line     One value per line
                   list     Values delimited by .separator string
                   pretty   Pretty printed SQL results (default)
.nullvalue STR   Use STRING in place of NULL values
.print STR...    Print literal STRING
.quit            Exit this program
.schema [TABLE]  Show the CREATE statements
.separator STR   Change separator used by output mode
.socket          Show the local osquery extensions socket path
.show            Show the current values for various settings
.summary         Alias for the show meta command
.tables [TABLE]  List names of tables
.types [SQL]     Show result of getQueryColumns for the given query
.width [NUM1]+   Set column widths for "column" mode
.timer ON|OFF    Turn the CPU timer measurement on or off
```

**Not:** Dokümana göre, meta-komutlar `.` ile başlar.

**Tabloları Listeleme**

Sorgulanabilir tüm tabloları listelemek için `.tables` meta-komutunu kullanın.

Örneğin, işlemlerle ilgili hangi tabloların olduğunu kontrol etmek isterseniz, `.tables process` komutunu kullanabilirsiniz.

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery> .table 
=> appcompat_shims
=> arp_cache
=> atom_packages
=> authenticode
=> autoexec
=> azure_instance_metadata
=> azure_instance_tags
=> background_activities_moderator
=> bitlocker_info
=> carbon_black_info
=> carves
=> certificates
=> chassis_info
=> chocolatey_packages
```

İçinde `user` kelimesi geçen tüm tabloları listelemek için `.tables user` komutunu kullanacağız:

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery> .table user
  => user_groups
  => user_ssh_keys
  => userassist
  => users
```

Yukarıdaki örnekte, `user` kelimesini içeren dört tablo döndürülmüştür.

**Tablo Şemasını Anlama**

Tablo adları, sorgulamadan ne tür bilgiler içerdiğini bilmek için yeterli değildir. Her tablo için sütunları ve türleri (şema olarak bilinir) bilmek de faydalıdır.

Bir tablonun şemasını listelemek için aşağıdaki meta-komutu kullanabiliriz: `.schema table_name`

Burada, kullanıcı tablosundaki sütunları anlamak istiyoruz.

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery> .schema users
CREATE TABLE users(`uid` BIGINT, `gid` BIGINT, `uid_signed` BIGINT, `gid_signed` BIGINT, `username` TEXT, `description` TEXT, `directory` TEXT, `shell` TEXT, `uuid` TEXT, `type` TEXT, `is_hidden` INTEGER HIDDEN, `pid_with_namespace` INTEGER HIDDEN, PRIMARY KEY (`uid`, `username`, `uuid`, `pid_with_namespace`)) WITHOUT ROWID;
```

Yukarıdaki sonuç, username, description, PID gibi sütun adlarını ve ilgili veri türlerini (BIGINT, TEXT, INTEGER vb.) sağlar. Bu şemadan birkaç sütun seçip, aşağıdaki SQL sorgusunu kullanarak osquery'den kullanıcı tablosundaki sütunları görüntülemesini isteyelim:

**SQL SORGUSU SÖZDİZİMİ:** `select column1, column2, column3 from table;`

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery> select gid, uid, description, username, directory from users;
+-----+------+------------------------------------------------------------+----------------------+-------------------------------------------+
| gid | uid  | description                                                | username             | directory                                 |
+-----+------+------------------------------------------------------------+----------------------+-------------------------------------------+
| 544 | 500  | Built-in account for administering the computer/domain     | Administrator        |                                           |
| 581 | 503  | A user account managed by the system.                      | DefaultAccount       |                                           |
| 546 | 501  | Built-in account for guest access to the computer/domain   | Guest                |                                           |
| 544 | 1002 |                                                            | James                | C:\Users\James                            |
| 18  | 18   |                                                            | SYSTEM               | %systemroot%\system32\config\systemprofile|
| 19  | 19   |                                                            | LOCAL SERVICE        | %systemroot%\ServiceProfiles\LocalService |
| 20  | 20   |                                                            | NETWORK SERVICE      | %systemroot%\ServiceProfiles\NetworkService|
+-----+------+------------------------------------------------------------+----------------------+-------------------------------------------+
```

**Görüntüleme Modu**

Osquery, seçebileceğiniz birden fazla görüntüleme moduyla birlikte gelir. Mevcut modları listelemek veya aşağıdaki gibi birini seçmek için `.help` seçeneğini kullanın:

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>.help
Welcome to the osquery shell. Please explore your OS!
You are connected to a transient 'in-memory' virtual database.
.
.
.
.mode MODE       Set output mode where MODE is one of:
                   csv      Comma-separated values
                   column   Left-aligned columns see .width
                   line     One value per line
                   list     Values delimited by .separator string
                   pretty   Pretty printed SQL results (default)
.
.
.
```

Çevrimiçi dokümantasyon, tabloların, sütun

ların, türlerin ve sütun açıklamalarının tam listesini görmek için kullanılabilir.

**Soruları Yanıtlayın**

Osquery'nin interaktif modunda `table process` sorgusunu çalıştırdığımızda kaç tablo döndürülür?

Submit

İşlemler tablosunun şemasına bakıldığında, belirli bir işlem için process id'yi hangi sütun görüntüler?

Submit

.help komutunu incelediğimizde, .mode komutu için kaç görüntüleme modu mevcuttur?

{% enddrawer %}

{% drawer Task 4 Schema Documentation %}

Bu görev için, Osquery sürüm 5.5.1'in şema [dokümantasyonuna](https://osquery.io/schema/5.5.1/) gidin. Şema dokümantasyonu aşağıda gösterildiği gibi görünmektedir:

![Overview of Schema Documentation](https://tryhackme-images.s3.amazonaws.com/user-uploads/5e8dd9a4a45e18443162feab/room-content/bffb88b6f01056f786be314da4cad299.png)

**Ayrıntılar**

Bu şema dokümantasyonunda bulunabilecek önemli bilgileri inceleyelim:

1. Çeşitli Osquery sürümlerini listeleyen bir açılır menü. Hangi sürüm için şema tablolarını görmek istediğinizi seçin.
2. Seçilen Osquery sürümünde bulunan tablo sayısı. (Yukarıdaki resimde 106 tablo mevcut).
3. Seçilen Osquery sürümü için tablolar alfabetik sırayla listelenmiştir. Bu, interaktif modda `.table` komutunu kullandığımızda elde ettiğimiz sonuçla aynıdır.
4. Tablonun adı ve kısa bir açıklaması.
5. Her tablonun **sütun**, **tür** ve **açıklama** 'sını gösteren ayrıntılı bir tablo.
6. Tablonun hangi işletim sistemine uygulandığı bilgisi. (Yukarıdaki resimde **account_policy_data** tablosu yalnızca **macOS** için kullanılabilir)
7. İşletim Sistemi seçmek için bir açılır menü. Birden fazla işletim sistemi seçebiliriz, bu da bu işletim sistemleri için mevcut olan tabloları görüntüler.

![Shows list of OS which Osquery supports](https://tryhackme-images.s3.amazonaws.com/user-uploads/5e8dd9a4a45e18443162feab/room-content/ee06ba38daf23aa4cdc7bae4af288a0c.png)

Bu kaynağı gezinmek ve gerekli bilgileri güvenle almak için yeterli bilgiye sahipsiniz.

**Soruları Yanıtlayın**

Osquery sürüm 5.5.1'de, hem Linux hem de Windows işletim sistemini seçtiğimizde kaç ortak tablo döndürülür?

Submit

Osquery sürüm 5.5.1'de, MAC OS için kaç tablo mevcuttur?

Submit

Windows işletim sisteminde, hangi tablo yüklü programları görüntülemek için kullanılır?

Submit

Windows işletim sisteminde, registry tablosunda registry değeri hangi sütunda bulunur?

{% enddrawer %}

{% drawer Task 5 Creating SQL queries %}

Osquery'de uygulanan SQL dili, alışık olabileceğiniz tüm SQL dilinden ziyade SQLite'ın bir üst kümesidir.

Gerçekçi olarak, tüm sorgularınız bir **SELECT** ifadesiyle başlayacaktır. Bu mantıklıdır çünkü Osquery ile yalnızca bir uç noktadaki bilgileri sorguluyorsunuz. Uç noktada herhangi bir bilgi/veri güncellemesi veya silmesi yapmayacaksınız.

**Kuralın istisnası**: **UPDATE** ve **DELETE** gibi diğer SQL ifadelerini kullanmak mümkündür, ancak yalnızca çalışma zamanı tabloları (görünümler) oluşturuyorsanız veya eklenti bu işlevleri destekliyorsa.

Sorgularınız ayrıca bir **FROM** cümlesi içerecek ve bir **noktalı virgülle** bitecektir.

**Kurulu Programları İnceleme**

Uç noktadaki kurulu programlar hakkında tüm bilgileri almak istiyorsanız, interaktif modda `.schema programs` komutunu kullanarak veya dokümantasyonunu [buradan](https://osquery.io/schema/5.5.1/#programs) kullanarak tablo şemasını anlamanız gerekmektedir.

**Sorgu:** `SELECT * FROM programs LIMIT 1;`

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>select * from programs limit 1;
              name = 7-Zip 21.07 (x64)
           version = 21.07
  install_location = C:\Program Files\7-Zip\
    install_source =
          language =
         publisher = Igor Pavlov
  uninstall_string = "C:\Program Files\7-Zip\Uninstall.exe"
      install_date =
identifying_number =
```

Yukarıdaki örnekte `LIMIT` kullanılarak sonuçların görüntülenmesini sınırlamak için bir sayı belirtilmiştir.

**Not:** Bu sorguyu bağlı VM'de veya yerel makinenizde (Osquery kuruluysa) çalıştırırsanız sonuçlarınız farklı olacaktır. Burada sonuçlar, satır modunda görüntülenmiştir.

Döndürülen sütun sayısı ihtiyacınız olandan fazla olabilir. Tablo içindeki her sütunu almak yerine, belirli sütunları seçebilirsiniz.

**Sorgu:** `SELECT name, version, install_location, install_date from programs limit 1;`

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>select name, version, install_location, install_date from programs limit 1;
            name = 7-Zip 21.07 (x64)
         version = 21.07
install_location = C:\Program Files\7-Zip\
    install_date =
```

Yukarıdaki sorgu, uç noktadaki programların adını, sürümünü, kurulum yerini ve kurulum tarihini listeleyecektir. Bu, uç noktanın ne kadar meşgul olduğuna bağlı olarak yine de birçok sonuç döndürecektir.

**Count**

Bir tablodaki programların veya girdilerin sayısını görmek için **count()** işlevini kullanabiliriz:

**Sorgu:** `SELECT count(*) from programs;`

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>select count(*) from programs;
count(*) = 160
```

**WHERE Clause**

Opsiyonel olarak, belirtilen kriterlere göre döndürülen sonuç listesini daraltmak için bir **WHERE** cümlesi kullanabilirsiniz. Aşağıdaki sorgu, kullanıcı tablosunu alacak ve yalnızca James kullanıcı adı için sonucu gösterecektir:

**Sorgu:** `SELECT * FROM users WHERE username='James';`

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>SELECT * FROM users WHERE username='James';
        uid = 1002
        gid = 544
 uid_signed = 1002
 gid_signed = 544
   username = James
description =
  directory = C:\Users\James
      shell = C:\Windows\system32\cmd.exe
       uuid = S-1-5-21-605937711-2036809076-574958819-1002
       type = local
```

**WHERE** cümlesinde kullanılabilecek filtreleme operatörleri şunlardır:

- `=` \[eşit\]
- `<>` \[eşit değil\]
- `>`, `>=` \[büyük, büyük veya eşit\]
- `<`, `<=` \[küçük, küçük veya eşit\]
- `BETWEEN` \[aralıkta\]
- `LIKE` \[kalıp joker aramalar\]
- `%` \[joker, birden fazla karakter\]
- `_` \[joker, tek karakter\]

**Wildcard Kurallarını Eşleştirme**

Aşağıda, dosya yapılarında joker karakterler kullanmanın örneklerini gösteren Osquery dokümantasyonundan bir ekran görüntüsü verilmiştir:

- `%`: Bir seviye için tüm dosyaları ve klasörleri eşleştirir.
- `%%`: Tüm dosyaları ve klasörleri özyinelemeli olarak eşleştirir.
- `%abc`: "abc" ile biten seviyedeki tüm dosyaları ve klasörleri eşleştirir.
- `abc%`: "abc" ile başlayan seviyedeki tüm dosyaları ve klasörleri eşleştirir.

**Eşleştirme Örnekleri**

- `/Users/%/Library`: Her kullanıcının Library klasöründeki değişiklikleri izleyin, _ancak içeriği değil_.
- `/Users/%/Library/`: Her Library klasöründeki dosyaların değişikliklerini izleyin, ancak alt dizinlerin içeriğini değil.
- `/Users/%/Library/%`: Her Library klasöründeki dosyaların değişikliklerini izleyin.
- `/Users/%

/Library/%%`: Her Library'deki değişiklikleri özyinelemeli olarak izleyin.
- `/bin/%sh`: `bin` dizininde `sh` ile biten değişiklikleri izleyin.

Bazı tabloların, bir değeri döndürmek için **WHERE** cümlesine _ihtiyacı vardır_, örneğin **file** tablosu. Gerekli **WHERE** cümlesi sorguya dahil edilmezse bir hata alırsınız.

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>select * from file;
W1017 12:38:29.730041 45744 virtual_table.cpp:965] Table file was queried without a required column in the WHERE clause
W1017 12:38:29.730041 45744 virtual_table.cpp:976] Please see the table documentation: https://osquery.io/schema/#file
Error: constraint failed
```

**JOIN Function Kullanarak Tabloları Birleştirme**

Osquery, ayrıca ortak bir sütuna dayalı olarak iki tabloyu birleştirmek için kullanılabilir. Bunu daha fazla açıklamak için iki tabloya bakalım. Aşağıda `users` tablosunun ve `processes` tablosunun şemaları verilmiştir.

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>.schema users
CREATE TABLE users(`uid` BIGINT, `gid` BIGINT, `uid_signed` BIGINT, `gid_signed` BIGINT, `username` TEXT, `description` TEXT, `directory` TEXT, `shell` TEXT, `uuid` TEXT, `type` TEXT, `is_hidden` INTEGER HIDDEN, `pid_with_namespace` INTEGER HIDDEN, PRIMARY KEY (`uid`, `username`, `uuid`, `pid_with_namespace`)) WITHOUT ROWID;

osquery>.schema processes
CREATE TABLE processes(`pid` BIGINT, `name` TEXT, `path` TEXT, `cmdline` TEXT, `state` TEXT, `cwd` TEXT, `root` TEXT, `uid` BIGINT, `gid` BIGINT, `euid` BIGINT, `egid` BIGINT, `suid` BIGINT, `sgid` BIGINT, `on_disk` INTEGER, `wired_size` BIGINT, `resident_size` BIGINT, `total_size` BIGINT, `user_time` BIGINT, `system_time` BIGINT, `disk_bytes_read` BIGINT, `disk_bytes_written` BIGINT, `start_time` BIGINT, `parent` BIGINT, `pgroup` BIGINT, `threads` INTEGER, `nice` INTEGER, `elevated_token` INTEGER, `secure_process` INTEGER, `protection_type` TEXT, `virtual_process` INTEGER, `elapsed_time` BIGINT, `handle_count` BIGINT, `percent_processor_time` BIGINT, `upid` BIGINT HIDDEN, `uppid` BIGINT HIDDEN, `cpu_type` INTEGER HIDDEN, `cpu_subtype` INTEGER HIDDEN, `translated` INTEGER HIDDEN, `cgroup_path` TEXT HIDDEN, `phys_footprint` BIGINT HIDDEN, PRIMARY KEY (`pid`)) WITHOUT ROWID;
```

Her iki şemaya bakıldığında, `users` tablosundaki `uid` kullanıcı kaydını tanımlamak için ve `processes` tablosundaki `uid` belirli bir işlemi yürüten kullanıcıyı temsil etmek için kullanılır. Bu `uid` alanını kullanarak her iki tabloyu da birleştirebiliriz:

**Sorgu1:** `select uid, pid, name, path from processes;`

**Sorgu2:** `select uid, username, description from users;`

**Birleştirilmiş Sorgu:** `select p.pid, p.name, p.path, u.username from processes p JOIN users u on u.uid=p.uid LIMIT 10;`

\--osquery interactive mode--

           
```
root@analyst$ osqueryi
Using a virtual database. Need help, type '.help'
osquery>select p.pid, p.name, p.path, u.username from processes p JOIN users u on u.uid=p.uid LIMIT 10;
+-------+-------------------+---------------------------------------+----------+
| pid   | name              | path                                  | username |
+-------+-------------------+---------------------------------------+----------+
| 7560  | sihost.exe        | C:\Windows\System32\sihost.exe        | James    |
| 6984  | svchost.exe       | C:\Windows\System32\svchost.exe       | James    |
| 7100  | svchost.exe       | C:\Windows\System32\svchost.exe       | James    |
| 7144  | svchost.exe       | C:\Windows\System32\svchost.exe       | James    |
| 8636  | ctfmon.exe        | C:\Windows\System32\ctfmon.exe        | James    |
| 8712  | taskhostw.exe     | C:\Windows\System32\taskhostw.exe     | James    |
| 9260  | svchost.exe       | C:\Windows\System32\svchost.exe       | James    |
| 10168 | RuntimeBroker.exe | C:\Windows\System32\RuntimeBroker.exe | James    |
| 10232 | RuntimeBroker.exe | C:\Windows\System32\RuntimeBroker.exe | James    |
| 8924  | svchost.exe       | C:\Windows\System32\svchost.exe       | James    |
+-------+-------------------+---------------------------------------+----------+
```

**Not:** SQL ve Osquery'ye özgü sorgular oluşturma konusunda daha fazla bilgi için lütfen Osquery [dokümantasyonuna](https://osquery.readthedocs.io/en/stable/introduction/sql/) bakın.

**Soruları Yanıtlayın**

Osquery'yi kullanarak, bu ana bilgisayarda kaç program yüklü?

Submit

Osquery'yi kullanarak, James kullanıcısının açıklaması nedir?

Submit

Aşağıdaki arama sorgusunu çalıştırdığımızda, RID '1009' olan kullanıcının tam SID'si nedir?

**Sorgu:** `select path, key, name from registry where key = 'HKEY_USERS';`

Submit

Aşağıdaki arama sorgusunu çalıştırdığımızda, bu makinede yüklü olan Internet Explorer tarayıcı uzantısı nedir?

**Sorgu:** `select * from ie_extensions;`

Submit

Aşağıdaki sorguyu çalıştırdıktan sonra döndürülen programın tam adı nedir?

**Sorgu:** `select name, install_location from programs where name LIKE '%wireshark%';`

{% enddrawer %}

{% drawer Task 6 Challenge and Conclusion %}

Çeşitli tabloları incelediğimize, arama sorguları oluşturmayı ve işletim sistemine sorular sormayı öğrendiğimize göre, bir meydan okuma zamanı geldi. OSquery'yi kullanarak ana bilgisayarı inceleyin ve aşağıdaki soruları yanıtlayın.

**Soruları Yanıtlayın**

Windows OS'de süreç yürütme kanıtlarını hangi tablo depolar?

Submit

Kullanıcılardan biri diskten izleri kaldırmak için bir program çalıştırmış gibi görünüyor; bu programın adı nedir?

Submit

Bu ana bilgisayarda yüklü VPN'i belirlemek için bir arama sorgusu oluşturun. Yazılımın adı nedir?

Submit

Bu ana bilgisayarda kaç hizmet çalışıyor?

Submit

**autoexec** tablosu, hedef makinede otomatik olarak çalıştırılan yürütülebilir dosyaların listesini içerir. Otomatik olarak çalıştırılan bir toplu iş dosyası (batch file) var gibi görünüyor. Bu toplu iş dosyasının adı nedir (uzantısı .bat ile birlikte)?

Submit

Yukarıdaki soruda bulunan toplu iş dosyasının tam yolu nedir? (Listede sonuncu)

{% enddrawer %}

## Wazuh

